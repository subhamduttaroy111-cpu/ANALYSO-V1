<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Trade Architect | Advanced Stock Analysis</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
:root {
    --bg: #f8fafc;
    --panel: #ffffff;
    --border: #e2e8f0;
    --blue: #3b82f6;
    --blue-dark: #2563eb;
    --text: #0f172a;
    --muted: #64748b;
    --success: #10b981;
    --danger: #ef4444;
    --warning: #f59e0b;
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

* {
    box-sizing: border-box;
    font-family: Inter, sans-serif;
    margin: 0;
    padding: 0;
}

body {
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
}

/* ========== HEADER ========== */
header {
    background: var(--panel);
    border-bottom: 1px solid var(--border);
    padding: 16px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: var(--shadow);
    position: sticky;
    top: 0;
    z-index: 100;
}

header h1 {
    font-size: 1.4rem;
    font-weight: 800;
    display: flex;
    align-items: center;
    gap: 8px;
}

header h1 span {
    color: var(--blue);
    font-size: 0.7rem;
    background: linear-gradient(135deg, var(--blue), var(--blue-dark));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.header-badge {
    font-size: 0.75rem;
    color: var(--muted);
    background: var(--bg);
    padding: 6px 12px;
    border-radius: 20px;
    font-weight: 600;
}

/* ========== HERO SECTION ========== */
.hero {
    max-width: 1200px;
    margin: 32px auto 20px;
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 40px;
    display: grid;
    grid-template-columns: 1.3fr 0.7fr;
    gap: 40px;
    box-shadow: var(--shadow);
}

.hero h2 {
    font-size: 2.2rem;
    font-weight: 800;
    margin-bottom: 12px;
    background: linear-gradient(135deg, var(--text), var(--muted));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.hero p {
    color: var(--muted);
    font-size: 1.05rem;
    line-height: 1.7;
}

.hero ul {
    list-style: none;
    margin-top: 20px;
}

.hero li {
    margin-bottom: 12px;
    padding-left: 28px;
    position: relative;
    font-weight: 500;
    color: var(--text);
}

.hero li:before {
    content: "‚úì";
    position: absolute;
    left: 0;
    color: var(--success);
    font-weight: 700;
    font-size: 1.1rem;
}

.hero-visual {
    border-radius: 16px;
    background: 
        linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.03)),
        repeating-linear-gradient(
            45deg,
            var(--border),
            var(--border) 1px,
            transparent 1px,
            transparent 16px
        );
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.1rem;
    color: var(--blue);
    text-align: center;
    padding: 20px;
}

/* ========== CONTROLS ========== */
.controls {
    padding: 16px;
    display: flex;
    justify-content: center;
}

.controls-box {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 8px;
    display: flex;
    gap: 12px;
    width: 100%;
    max-width: 520px;
    box-shadow: var(--shadow);
}

select {
    flex: 1;
    border: none;
    padding: 14px 16px;
    font-size: 0.95rem;
    font-weight: 600;
    outline: none;
    cursor: pointer;
    border-radius: 10px;
    background: var(--bg);
    color: var(--text);
}

button {
    background: linear-gradient(135deg, var(--blue), var(--blue-dark));
    color: #fff;
    border: none;
    padding: 14px 32px;
    border-radius: 12px;
    font-weight: 700;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
}

button:active {
    transform: translateY(0);
}

/* ========== LOADER ========== */
.loader {
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 100px 20px;
    color: var(--muted);
    text-align: center;
}

.spinner {
    width: 48px;
    height: 48px;
    border: 4px solid var(--border);
    border-top: 4px solid var(--blue);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-bottom: 20px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loader b {
    font-size: 1.1rem;
    color: var(--text);
    margin-bottom: 8px;
}

/* ========== GRID ========== */
.container {
    padding: 20px;
    max-width: 1400px;
    margin: 0 auto;
}

.grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 24px;
}

/* ========== ENHANCED CARD ========== */
.card {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: var(--shadow);
    position: relative;
    overflow: hidden;
}

.card:hover {
    transform: translateY(-6px);
    box-shadow: var(--shadow-lg);
    border-color: var(--blue);
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 16px;
}

.card h3 {
    font-size: 1.2rem;
    font-weight: 700;
    margin-bottom: 4px;
}

.price {
    font-size: 1.6rem;
    font-weight: 800;
    color: var(--text);
    margin: 8px 0;
}

.badge {
    font-size: 0.7rem;
    padding: 6px 10px;
    border-radius: 8px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.bull {
    background: #d1fae5;
    color: #065f46;
}

.neutral {
    background: #f3f4f6;
    color: #374151;
}

.bear {
    background: #fee2e2;
    color: #991b1b;
}

/* ========== VISUAL SL/TARGET INDICATOR ========== */
.price-range {
    margin: 20px 0;
    padding: 16px;
    background: var(--bg);
    border-radius: 12px;
}

.range-labels {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    font-size: 0.75rem;
    font-weight: 600;
}

.range-labels .sl {
    color: var(--danger);
}

.range-labels .entry {
    color: var(--warning);
}

.range-labels .target {
    color: var(--success);
}

.range-bar {
    height: 8px;
    background: linear-gradient(
        to right,
        var(--danger) 0%,
        var(--danger) 33%,
        var(--warning) 33%,
        var(--warning) 50%,
        var(--success) 50%,
        var(--success) 100%
    );
    border-radius: 8px;
    position: relative;
    margin-bottom: 6px;
}

.current-price-marker {
    position: absolute;
    top: -4px;
    width: 3px;
    height: 16px;
    background: var(--text);
    border-radius: 2px;
    transition: left 0.3s ease;
}

.current-price-marker::after {
    content: '';
    position: absolute;
    top: -4px;
    left: -3px;
    width: 9px;
    height: 9px;
    background: var(--text);
    border: 2px solid white;
    border-radius: 50%;
}

.range-values {
    display: flex;
    justify-content: space-between;
    font-size: 0.8rem;
    margin-top: 8px;
}

.range-values div {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.range-values span:first-child {
    font-weight: 600;
    font-size: 0.7rem;
    color: var(--muted);
    margin-bottom: 2px;
}

.range-values span:last-child {
    font-weight: 700;
}

/* ========== INDICATORS ROW ========== */
.indicators {
    display: flex;
    gap: 8px;
    margin: 12px 0;
    flex-wrap: wrap;
}

.indicator-badge {
    font-size: 0.7rem;
    padding: 4px 10px;
    border-radius: 6px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 4px;
}

.indicator-badge.rsi {
    background: #dbeafe;
    color: #1e40af;
}

.indicator-badge.macd-buy {
    background: #d1fae5;
    color: #065f46;
}

.indicator-badge.macd-sell {
    background: #fee2e2;
    color: #991b1b;
}

.indicator-badge.volume {
    background: #fef3c7;
    color: #92400e;
}

/* ========== CARD FOOTER ========== */
.card-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--border);
    font-size: 0.8rem;
}

.score-display {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 700;
}

.score-bar {
    width: 60px;
    height: 6px;
    background: var(--border);
    border-radius: 3px;
    overflow: hidden;
}

.score-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--warning), var(--success));
    border-radius: 3px;
    transition: width 0.3s ease;
}

.rr-display {
    font-weight: 700;
    color: var(--success);
}

/* ========== MODAL ========== */
.modal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.modal-box {
    background: #fff;
    width: 96%;
    max-width: 1000px;
    border-radius: 20px;
    padding: 32px;
    max-height: 92vh;
    overflow-y: auto;
    box-shadow: var(--shadow-lg);
    animation: slideUp 0.3s ease;
}

@keyframes slideUp {
    from {
        transform: translateY(30px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 2px solid var(--border);
}

.modal-header h2 {
    font-size: 1.8rem;
    font-weight: 800;
}

.close-btn {
    background: var(--bg);
    color: var(--text);
    padding: 8px 16px;
    font-size: 0.85rem;
    box-shadow: none;
}

.close-btn:hover {
    background: var(--border);
}

.modal-section {
    margin: 24px 0;
}

.modal-section h4 {
    font-size: 1rem;
    font-weight: 700;
    margin-bottom: 12px;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.fundamentals-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin: 16px 0;
}

.fund-item {
    background: var(--bg);
    padding: 16px;
    border-radius: 12px;
}

.fund-item label {
    font-size: 0.8rem;
    color: var(--muted);
    font-weight: 600;
    display: block;
    margin-bottom: 4px;
}

.fund-item value {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--text);
}

.reasons-list {
    list-style: none;
    padding: 0;
}

.reasons-list li {
    padding: 12px 16px;
    background: var(--bg);
    margin-bottom: 8px;
    border-radius: 10px;
    font-weight: 500;
    border-left: 3px solid var(--blue);
}

iframe {
    border: none;
    border-radius: 12px;
    box-shadow: var(--shadow);
}

/* ========== RESPONSIVE ========== */
@media (max-width: 768px) {
    .hero {
        grid-template-columns: 1fr;
        padding: 28px;
    }

    .hero h2 {
        font-size: 1.7rem;
    }

    .controls-box {
        flex-direction: column;
    }

    button {
        width: 100%;
    }

    .grid {
        grid-template-columns: 1fr;
    }

    .modal-box {
        padding: 24px;
    }
}
</style>
</head>

<body>

<header>
    <h1>ANALYSO <span>PROFESSIONAL</span></h1>
    <div class="header-badge">NSE ‚Ä¢ Live Analysis</div>
</header>

<div class="hero">
    <div>
        <h2>Advanced Market Intelligence</h2>
        <p>
            Institutional-grade analysis engine powered by multi-indicator confirmation,
            MACD crossovers, volume analysis, and dynamic risk management across all timeframes.
        </p>
        <ul>
            <li>MACD + RSI + EMA trend confirmation</li>
            <li>Risk-reward optimized entries (min 1.5:1)</li>
            <li>Volume-validated breakouts</li>
            <li>Dynamic ATR-based stop losses</li>
        </ul>
    </div>
    <div class="hero-visual">
        üìä<br>Multi-Indicator<br>Analysis Engine
    </div>
</div>

<div class="controls">
    <div class="controls-box">
        <select id="mode">
            <option value="INTRADAY">üöÄ Intraday (15m)</option>
            <option value="SWING">üåä Swing (Daily)</option>
            <option value="LONG_TERM">üíé Long Term (Weekly)</option>
        </select>
        <button onclick="runScan()">SCAN MARKET</button>
    </div>
</div>

<div class="container">
    <div id="loader" class="loader">
        <div class="spinner"></div>
        <b>Scanning market with advanced indicators...</b>
        <small>Analyzing MACD, RSI, Volume & Price Action</small>
    </div>
    <div id="grid" class="grid"></div>
</div>

<!-- MODAL -->
<div id="modal" class="modal" onclick="closeModal(event)">
    <div class="modal-box">
        <div class="modal-header">
            <h2 id="mTitle"></h2>
            <button class="close-btn" onclick="closeModal()">‚úï Close</button>
        </div>

        <div style="margin: 24px 0;">
            <iframe id="tv_iframe" style="width:100%; height:460px;"></iframe>
        </div>

        <div class="modal-section">
            <h4>üìä Fundamentals</h4>
            <div class="fundamentals-grid">
                <div class="fund-item">
                    <label>Sector</label>
                    <value id="mSector">-</value>
                </div>
                <div class="fund-item">
                    <label>52W High</label>
                    <value id="mHigh">-</value>
                </div>
                <div class="fund-item">
                    <label>52W Low</label>
                    <value id="mLow">-</value>
                </div>
                <div class="fund-item">
                    <label>Market Cap</label>
                    <value id="mCap">-</value>
                </div>
            </div>
        </div>

        <div class="modal-section">
            <h4>‚úì Analysis Logic</h4>
            <ul id="mReasons" class="reasons-list"></ul>
        </div>
    </div>
</div>

<script>
const API_URL = "https://analysov1-backend.onrender.com";

let STOCKS = [];

async function runScan() {
    loader.style.display = "flex";
    grid.innerHTML = "";

    const mode = document.getElementById("mode").value;
    
    try {
        const res = await fetch(`${API_URL}/scan`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ mode })
        });
        const json = await res.json();

        loader.style.display = "none";
        
        if (json.status === "success") {
            STOCKS = json.data;
            renderCards(STOCKS);
        }
    } catch (error) {
        loader.style.display = "none";
        grid.innerHTML = "<p style='text-align:center;color:var(--muted);padding:40px;'>‚ùå Error connecting to server. Please try again.</p>";
    }
}

function renderCards(data) {
    if (data.length === 0) {
        grid.innerHTML = "<p style='text-align:center;color:var(--muted);padding:60px;'>No high-probability setups found. Try a different timeframe.</p>";
        return;
    }

    grid.innerHTML = "";
    
    data.forEach((s, i) => {
        const cls = s.bias.includes("BULL") ? "bull" : s.bias.includes("BEAR") ? "bear" : "neutral";
        
        // Calculate position of current price between SL and Target
        const range = s.execution.target1 - s.execution.sl;
        const currentPos = s.ltp - s.execution.sl;
        const percentage = Math.max(0, Math.min(100, (currentPos / range) * 100));

        const card = document.createElement('div');
        card.className = 'card';
        card.onclick = () => openModal(i);
        
        card.innerHTML = `
            <div class="card-header">
                <div>
                    <h3>${s.symbol}</h3>
                    <span class="badge ${cls}">${s.bias}</span>
                </div>
            </div>
            
            <div class="price">‚Çπ${s.ltp.toLocaleString()}</div>
            
            <div class="indicators">
                <span class="indicator-badge rsi">RSI ${s.indicators.rsi}</span>
                <span class="indicator-badge macd-${s.indicators.macd.toLowerCase()}">${s.indicators.macd}</span>
                <span class="indicator-badge volume">${s.indicators.volume} VOL</span>
            </div>
            
            <div class="price-range">
                <div class="range-labels">
                    <span class="sl">SL</span>
                    <span class="entry">ENTRY</span>
                    <span class="target">TARGET</span>
                </div>
                <div class="range-bar">
                    <div class="current-price-marker" style="left: ${percentage}%"></div>
                </div>
                <div class="range-values">
                    <div>
                        <span>SL</span>
                        <span style="color: var(--danger);">‚Çπ${s.execution.sl}</span>
                    </div>
                    <div>
                        <span>ENTRY</span>
                        <span style="color: var(--warning);">‚Çπ${s.execution.entry}</span>
                    </div>
                    <div>
                        <span>TGT</span>
                        <span style="color: var(--success);">‚Çπ${s.execution.target1}</span>
                    </div>
                </div>
            </div>
            
            <div class="card-footer">
                <div class="score-display">
                    <span>SCORE</span>
                    <div class="score-bar">
                        <div class="score-fill" style="width: ${s.score}%"></div>
                    </div>
                    <span>${s.score}%</span>
                </div>
                <div class="rr-display">R:R ${s.execution.rr_ratio}:1</div>
            </div>
        `;
        
        grid.appendChild(card);
    });
}

async function openModal(i) {
    const s = STOCKS[i];
    modal.style.display = "flex";
    mTitle.innerText = s.symbol;

    loadChart(s.symbol);
    
    mReasons.innerHTML = s.reason.map(r => `<li>${r}</li>`).join("");

    try {
        const res = await fetch(`${API_URL}/get_stock_details`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ symbol: s.symbol })
        });
        const json = await res.json();
        
        if (json.status === "success") {
            mSector.innerText = json.fundamentals.sector;
            mHigh.innerText = json.fundamentals.high52 !== 'N/A' ? `‚Çπ${json.fundamentals.high52}` : 'N/A';
            mLow.innerText = json.fundamentals.low52 !== 'N/A' ? `‚Çπ${json.fundamentals.low52}` : 'N/A';
            mCap.innerText = json.fundamentals.marketCap !== 'N/A' ? formatMarketCap(json.fundamentals.marketCap) : 'N/A';
        }
    } catch (error) {
        console.error("Error fetching details:", error);
    }
}

function formatMarketCap(cap) {
    if (cap === 'N/A') return 'N/A';
    const crore = cap / 10000000;
    if (crore >= 100000) {
        return `‚Çπ${(crore / 100000).toFixed(2)}L Cr`;
    }
    return `‚Çπ${crore.toFixed(0)} Cr`;
}

function loadChart(symbol) {
    symbol = symbol.replace(".NS", "");
    const mode = document.getElementById("mode").value;
    
    let interval = "15";
    if (mode === "SWING") interval = "D";
    if (mode === "LONG_TERM") interval = "W";

    tv_iframe.src = 
        "https://www.tradingview.com/widgetembed/?" +
        "symbol=" + symbol +
        "&exchange=NSE" +
        "&interval=" + interval +
        "&hidesidetoolbar=1" +
        "&hidetoptoolbar=1" +
        "&theme=light" +
        "&style=1" +
        "&timezone=Asia%2FKolkata" +
        "&studies=RSI@tv-basicstudies%1FMACD@tv-basicstudies" +
        "&studies_overrides={}" +
        "&enabled_features=[]" +
        "&disabled_features=[]";
}

function closeModal(e) {
    if (!e || e.target.id === "modal") {
        modal.style.display = "none";
    }
}

// Auto-scan on load with default mode
window.addEventListener('load', () => {
    console.log("‚úÖ Trade Architect Professional Loaded");
});
</script>

</body>
</html>